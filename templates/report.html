{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12 print:p-0 print:w-full print:max-w-none" id="report-container">

    <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 print:shadow-none">

        <!-- Report Header -->
        <div class="bg-slate-900 text-white p-8">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold font-serif">MEDICAL MENTAL HEALTH REPORT</h1>
                    <p class="text-slate-400 mt-2">VisoMind AI Assessment System</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-slate-400">REPORT ID</p>
                    <p class="font-mono text-lg" id="report-id">P-20260216-001</p>
                </div>
            </div>
        </div>

        <div class="p-8 space-y-8">

            <!-- Patient & Exam Info -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 pb-8 border-b border-gray-100">
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Date</p>
                    <p class="mt-1 font-medium text-gray-900" id="exam-date">-</p>
                </div>
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Patient Name</p>
                    <p class="mt-1 font-medium text-gray-900" id="patient-name-display">Anonymous</p>
                </div>
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Department</p>
                    <p class="mt-1 font-medium text-gray-900">Psychological Medicine</p>
                </div>
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</p>
                    <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        Finalized
                    </span>
                </div>
            </div>

            <!-- Analysis Section -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Visual Data -->
                <div class="col-span-1">
                    <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                        <span class="w-2 h-8 bg-brand-500 rounded-full mr-3"></span>
                        Patient Photo
                    </h3>
                    <div
                        class="aspect-square bg-gray-100 rounded-xl overflow-hidden shadow-inner flex items-center justify-center">
                        <img id="patient-photo" src="" alt="Analyzed Face" class="w-full h-full object-cover">
                        <span id="no-photo" class="text-gray-400 hidden">No Image</span>
                    </div>
                </div>

                <!-- Metrics -->
                <div class="col-span-2 space-y-6">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-2 h-8 bg-indigo-500 rounded-full mr-3"></span>
                            AI Diagnostic Metrics
                        </h3>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <p class="text-sm text-gray-500">Predicted Gender</p>
                                <p class="text-xl font-bold text-gray-900 mt-1" id="res-gender">-</p>
                            </div>
                            <div class="bg-brand-50 p-4 rounded-lg">
                                <p class="text-sm text-brand-700">Facial Emotion</p>
                                <p class="text-xl font-bold text-brand-900 mt-1 uppercase" id="res-face-emotion">-</p>
                            </div>
                            <div class="bg-indigo-50 p-4 rounded-lg">
                                <p class="text-sm text-indigo-700">Vocal Emotion</p>
                                <p class="text-xl font-bold text-indigo-900 mt-1 uppercase" id="res-voice-emotion">-</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <p class="text-sm text-gray-500">Voice Tone</p>
                                <p class="text-xl font-bold text-gray-900 mt-1" id="res-tone">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Clinical Observations -->
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2">Clinical Observations</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-600 text-sm bg-gray-50 p-4 rounded-lg"
                            id="observations-list">
                            <li>Analysis pending...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Advanced Analysis Section -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center border-b pb-2">
                    <span class="w-2 h-8 bg-purple-600 rounded-full mr-3"></span>
                    Advanced Psychological Analysis
                </h3>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left Column: Metrics -->
                    <div class="space-y-6">
                        <!-- Sentiment & Emotion -->
                        <div class="bg-slate-50 p-5 rounded-xl border border-slate-100">
                            <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Overall
                                Sentiment</h4>
                            <div class="flex items-end space-x-2">
                                <span class="text-3xl font-bold text-gray-900" id="adv-sentiment">-</span>
                                <span class="text-sm text-gray-500 mb-1">(Confidence: <span
                                        id="adv-confidence">-</span>%)</span>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                            <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Dominant
                                Emotion</h4>
                            <p class="text-2xl font-bold text-brand-600 uppercase" id="adv-emotion">-</p>
                            <p class="text-sm text-gray-600 mt-1 italic" id="adv-emotion-expl">-</p>
                        </div>

                        <!-- Voice Characteristics -->
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                            <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Voice
                                Characteristics</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between border-b border-gray-100 pb-1">
                                    <span class="text-gray-600">Volume Level</span>
                                    <span class="font-mono font-medium text-gray-900" id="vc-volume">-</span>
                                </div>
                                <div class="flex justify-between border-b border-gray-100 pb-1">
                                    <span class="text-gray-600">Pitch Level</span>
                                    <span class="font-mono font-medium text-gray-900" id="vc-pitch">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Voice Stability</span>
                                    <span class="font-mono font-medium text-gray-900" id="vc-stability">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Reading Accuracy -->
                        <div class="bg-indigo-50 p-5 rounded-xl border border-indigo-100">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-sm font-semibold text-indigo-800 uppercase tracking-wider">Reading
                                    Accuracy</h4>
                                <span class="text-2xl font-bold text-indigo-900" id="adv-reading">-</span>
                            </div>
                            <div class="w-full bg-indigo-200 rounded-full h-2">
                                <div class="bg-indigo-600 h-2 rounded-full" style="width: 0%" id="reading-bar"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Chart & Score -->
                    <div class="space-y-6">
                        <!-- Psychological Indicators Chart -->
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm h-80">
                            <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Psychological
                                Indicators</h4>
                            <div class="relative h-60 w-full">
                                <canvas id="psych-chart"></canvas>
                            </div>
                        </div>

                        <!-- Overall Score & Risk -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-4 rounded-xl border-l-4 border-blue-500 shadow-sm">
                                <p class="text-xs font-semibold text-gray-500 uppercase">Mental Health Score</p>
                                <p class="text-3xl font-bold text-gray-900 mt-1"><span id="mh-score">-</span><span
                                        class="text-sm text-gray-400 font-normal">/100</span></p>
                            </div>
                            <div class="bg-white p-4 rounded-xl border-l-4 border-red-500 shadow-sm">
                                <p class="text-xs font-semibold text-gray-500 uppercase">Risk Level</p>
                                <p class="text-xl font-bold text-red-600 mt-2" id="risk-level">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Short Explanation -->
                <div class="mt-8 bg-slate-900 text-white p-6 rounded-xl">
                    <h4 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-2">Analysis Summary</h4>
                    <p class="text-lg leading-relaxed font-light" id="short-explanation">
                        Analysis in progress...
                    </p>
                </div>
            </div>

            <!-- Overall Assessment -->
            <div class="bg-amber-50 border-l-4 border-amber-400 p-6 rounded-r-lg">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-amber-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-bold text-amber-800 uppercase tracking-wide">Overall Assessment</h3>
                        <p class="mt-2 text-lg font-medium text-amber-900" id="overall-condition">
                            Analyzing...
                        </p>
                    </div>
                </div>
            </div>

            <!-- Recommendations -->
            <div>
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                    <span class="w-2 h-8 bg-green-500 rounded-full mr-3"></span>
                    Medical Recommendations
                </h3>
                <div class="prose prose-brand max-w-none text-gray-600 bg-white p-6 rounded-xl border border-gray-200">
                    <ul class="space-y-2 list-none p-0 m-0" id="recommendations-list">
                    </ul>
                </div>
            </div>

            <!-- Footer -->
            <div class="border-t border-gray-100 pt-8 mt-8 text-center text-xs text-gray-400">
                <p>Generated by VisoMind AI System v1.0</p>
                <p class="mt-1">Disclaimer: This report is generated by AI and is not a substitute for professional
                    medical advice.</p>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="mt-8 flex justify-center space-x-4 print:hidden" id="action-buttons">
        <button onclick="downloadReport()"
            class="px-6 py-3 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-50 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
            Download Report (PDF)
        </button>
        <button onclick="window.location.href='/'"
            class="px-6 py-3 bg-brand-600 text-white font-semibold rounded-lg shadow-lg hover:bg-brand-700 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Start New Assessment
        </button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function downloadReport() {
        const element = document.getElementById('report-container');
        const actionsDiv = document.getElementById('action-buttons');

        // Hide buttons temporarily
        actionsDiv.style.display = 'none';

        // Temporarily adjust styling for PDF generation to ensure fit
        const originalWidth = element.style.width;
        const originalMaxWidth = element.style.maxWidth;
        const originalPadding = element.style.padding;

        // Force A4-friendly width (approx 794px for A4 at 96dpi, minus margins)
        // We'll set a fixed width to ensure consistency
        element.style.width = '100%';
        element.style.maxWidth = '100%';
        // Remove padding that might cause double margins with html2pdf
        element.style.padding = '0';

        const opt = {
            margin: [0.2, 0.2, 0.5, 0.2], // Top, Left, Bottom, Right
            filename: 'VisoMind_Report_' + new Date().toISOString().split('T')[0] + '.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: {
                scale: 2,
                useCORS: true,
                scrollY: 0,
                letterRendering: true
            },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            // Restore buttons and styling
            actionsDiv.style.display = 'flex';
            element.style.width = originalWidth;
            element.style.maxWidth = originalMaxWidth;
            element.style.padding = originalPadding;
        }).catch(err => {
            console.error("PDF generation error:", err);
            actionsDiv.style.display = 'flex';
            element.style.width = originalWidth;
            element.style.maxWidth = originalMaxWidth;
            element.style.padding = originalPadding;
            alert("Could not generate PDF. Please try printing.");
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const dataStr = localStorage.getItem('visomind_report');
        if (!dataStr) {
            alert("No report data found. Redirecting to home.");
            window.location.href = '/';
            return;
        }

        const data = JSON.parse(dataStr);

        // Populate fields
        document.getElementById('report-id').textContent = 'R-' + Math.floor(Math.random() * 1000000);
        document.getElementById('exam-date').textContent = data.timestamp;

        // Patient Name
        if (data.patient_name) {
            document.getElementById('patient-name-display').textContent = data.patient_name;
        }

        // Image logic
        if (data.face_image_path) {
            let imgPath = data.face_image_path;

            // Check if it's a base64 data URL
            if (imgPath.startsWith('data:image')) {
                // Use directly
            } else {
                // Path handling for Windows/Unix compatibility
                imgPath = imgPath.replace(/\\/g, '/');

                // Extract relative path from static
                const staticIndex = imgPath.indexOf('static/');
                if (staticIndex !== -1) {
                    imgPath = '/' + imgPath.substring(staticIndex);
                }
                // Ensure leading slash
                if (!imgPath.startsWith('/')) {
                    imgPath = '/' + imgPath;
                }
            }

            const imgElement = document.getElementById('patient-photo');
            imgElement.src = imgPath;
            imgElement.onerror = function () {
                this.classList.add('hidden');
                document.getElementById('no-photo').classList.remove('hidden');
            };
        } else {
            document.getElementById('patient-photo').classList.add('hidden');
            document.getElementById('no-photo').classList.remove('hidden');
        }

        // Metrics
        const face = data.face_analysis || {};
        const voice = data.voice_analysis || {};
        const voiceFeat = voice.voice_features || {};
        const adv = voice.advanced_metrics || {};

        document.getElementById('res-gender').textContent = face.gender || 'N/A';
        document.getElementById('res-face-emotion').textContent = face.emotion || 'N/A';
        document.getElementById('res-voice-emotion').textContent = voice.primary_emotion || 'N/A';
        document.getElementById('res-tone').textContent = voiceFeat.tone || 'N/A';

        document.getElementById('overall-condition').textContent = data.overall_condition;

        // --- Advanced Metrics Population ---
        if (Object.keys(adv).length > 0) {
            // Sentiment & Emotion
            document.getElementById('adv-sentiment').textContent = adv.sentiment || '-';
            document.getElementById('adv-confidence').textContent = adv.confidence || '0';
            document.getElementById('adv-emotion').textContent = adv.dominant_emotion || '-';
            document.getElementById('adv-emotion-expl').textContent = adv.emotion_explanation || '';

            // Voice Characteristics (Detailed)
            document.getElementById('vc-volume').textContent = voiceFeat.volume_level || '-';
            document.getElementById('vc-pitch').textContent = voiceFeat.pitch_level || '-';
            document.getElementById('vc-stability').textContent = voiceFeat.stability || '-';

            // Reading Accuracy
            const readingAcc = (adv.reading_accuracy * 100).toFixed(0);
            document.getElementById('adv-reading').textContent = readingAcc + '%';
            document.getElementById('reading-bar').style.width = readingAcc + '%';

            // Score & Risk
            document.getElementById('mh-score').textContent = adv.mh_score || '-';
            document.getElementById('risk-level').textContent = adv.risk_level || '-';
            document.getElementById('short-explanation').textContent = adv.explanation || 'No details available.';

            // Chart
            const ctx = document.getElementById('psych-chart').getContext('2d');
            const psych = adv.psychological || { anxiety: 0, depression: 0, stress: 0, stability: 0 };

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Anxiety', 'Depression', 'Stress', 'Emotional Stability'],
                    datasets: [{
                        label: 'Score (0-100)',
                        data: [psych.anxiety, psych.depression, psych.stress, psych.stability],
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.7)',  // Red
                            'rgba(59, 130, 246, 0.7)', // Blue
                            'rgba(249, 115, 22, 0.7)', // Orange
                            'rgba(16, 185, 129, 0.7)'  // Green
                        ],
                        borderColor: [
                            'rgb(239, 68, 68)',
                            'rgb(59, 130, 246)',
                            'rgb(249, 115, 22)',
                            'rgb(16, 185, 129)'
                        ],
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { display: true, drawBorder: false }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Lists
        const obsList = document.getElementById('observations-list');
        obsList.innerHTML = '';
        (data.clinical_observations || []).forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            obsList.appendChild(li);
        });

        const recList = document.getElementById('recommendations-list');
        recList.innerHTML = '';
        (data.recommendations || []).forEach(item => {
            const li = document.createElement('li');
            li.className = "flex items-start";
            li.innerHTML = `<span class="text-green-500 mr-2">âœ“</span> ${item}`;
            recList.appendChild(li);
        });
    });
</script>
{% endblock %}