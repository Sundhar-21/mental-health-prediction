{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

    <div class="text-center mb-12">
        <h1 class="text-3xl font-bold text-gray-900">Upload Files for Analysis</h1>
        <p class="text-gray-500 mt-2">Upload an image of a face and an audio recording for processing.</p>
    </div>

    <form id="upload-form" class="space-y-8" action="/analyze" method="POST" enctype="multipart/form-data">

        <!-- Patient Name Input -->
        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
            <label for="patient-name" class="block text-sm font-medium text-gray-700 mb-2">Patient Name</label>
            <input type="text" name="patient_name" id="patient-name" 
                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm p-3 border"
                placeholder="Enter patient name" required>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Image Upload -->
            <div class="relative group">
                <div
                    class="absolute -inset-0.5 bg-gradient-to-r from-pink-600 to-purple-600 rounded-lg blur opacity-25 group-hover:opacity-100 transition duration-1000 group-hover:duration-200">
                </div>
                <div class="relative bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">ðŸ“¸ Face Image</h3>
                    <div class="flex items-center justify-center w-full">
                        <label for="face-file"
                            class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-8 h-8 mb-4 text-gray-500" aria-hidden="true"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2" />
                                </svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span>
                                    or drag and drop</p>
                                <p class="text-xs text-gray-500">SVG, PNG, JPG or GIF (MAX. 800x400px)</p>
                            </div>
                            <input id="face-file" name="face_image" type="file" class="hidden" accept="image/*" />
                        </label>
                    </div>
                </div>
            </div>

            <!-- Audio Upload -->
            <div class="relative group">
                <div
                    class="absolute -inset-0.5 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-lg blur opacity-25 group-hover:opacity-100 transition duration-1000 group-hover:duration-200">
                </div>
                <div class="relative bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">ðŸŽ¤ Voice Recording</h3>
                    <div class="flex items-center justify-center w-full">
                        <label for="audio-file"
                            class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-8 h-8 mb-4 text-gray-500" aria-hidden="true"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                </svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span>
                                    or drag and drop</p>
                                <p class="text-xs text-gray-500">WAV or MP3 (MAX. 10MB)</p>
                            </div>
                            <input id="audio-file" name="voice_audio" type="file" class="hidden" accept="audio/*" />
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        <div id="file-previews" class="grid grid-cols-1 md:grid-cols-2 gap-8 hidden">
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 flex items-center space-x-4">
                <img id="preview-image" src="" class="w-16 h-16 object-cover rounded-md hidden">
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate" id="filename-face"></p>
                    <p class="text-xs text-gray-500">Ready to upload</p>
                </div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 flex items-center space-x-4">
                <div class="w-16 h-16 bg-blue-100 rounded-md flex items-center justify-center text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                    </svg>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate" id="filename-audio"></p>
                    <p class="text-xs text-gray-500">Ready to upload</p>
                </div>
            </div>
        </div>

        <button type="submit"
            class="w-full py-4 text-white bg-gradient-to-r from-brand-600 to-indigo-600 hover:from-brand-700 hover:to-indigo-700 rounded-lg shadow-lg font-semibold text-xl transition-all transform hover:scale-[1.01] active:scale-[0.99]">
            Generate Medical Report
        </button>
    </form>
</div>

<script>
    // File Previews
    document.getElementById('face-file').onchange = function (e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('file-previews').classList.remove('hidden');
            const faceName = document.getElementById('filename-face');
            faceName.textContent = file.name;
            faceName.title = file.name;

            const reader = new FileReader();
            reader.onload = function (e) {
                const img = document.getElementById('preview-image');
                img.src = e.target.result;
                img.classList.remove('hidden');
            }
            reader.readAsDataURL(file);
        }
    };

    document.getElementById('audio-file').onchange = function (e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('file-previews').classList.remove('hidden');
            const audioName = document.getElementById('filename-audio');
            audioName.textContent = file.name;
            audioName.title = file.name;
        }
    };

    // Handle form submission via AJAX to reuse the report page logic
    document.getElementById('upload-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<div class="loader inline-block"></div> Processing...';
        submitBtn.disabled = true;

        try {
            const response = await fetch('/analyze', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                localStorage.setItem('visomind_report', JSON.stringify(result));
                window.location.href = '/report';
            } else {
                alert('Analysis failed: ' + (result.error || 'Unknown error'));
                submitBtn.innerHTML = 'Generate Medical Report';
                submitBtn.disabled = false;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred.');
            submitBtn.innerHTML = 'Generate Medical Report';
            submitBtn.disabled = false;
        }
    });
</script>
{% endblock %}